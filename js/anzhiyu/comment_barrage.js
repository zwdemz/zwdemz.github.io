if(document.querySelector(".comment-barrage")){var commentBarrageConfig={maxBarrage:GLOBAL_CONFIG.commentBarrageConfig.maxBarrage,barrageTime:GLOBAL_CONFIG.commentBarrageConfig.barrageTime,twikooUrl:GLOBAL_CONFIG.twikooEnvId,accessToken:GLOBAL_CONFIG.commentBarrageConfig.accessToken,mailMd5:GLOBAL_CONFIG.commentBarrageConfig.mailMd5,pageUrl:window.location.pathname,barrageTimer:[],barrageList:[],barrageIndex:0,dom:document.querySelector(".comment-barrage")};var commentInterval=null;var hoverOnCommentBarrage=false;document.querySelector(".comment-barrage").addEventListener("mouseenter",(function(){hoverOnCommentBarrage=true}));document.querySelector(".comment-barrage").addEventListener("mouseleave",(function(){hoverOnCommentBarrage=false}));function initCommentBarrage(){if(!commentBarrageConfig.dom)return;var e=JSON.stringify({event:"COMMENT_GET","commentBarrageConfig.accessToken":commentBarrageConfig.accessToken,url:commentBarrageConfig.pageUrl});var a=new XMLHttpRequest;a.withCredentials=true;a.addEventListener("readystatechange",(function(){if(this.readyState===4&&this.responseText){commentBarrageConfig.barrageList=commentLinkFilter(JSON.parse(this.responseText).data);commentBarrageConfig.dom.innerHTML=""}}));a.open("POST",commentBarrageConfig.twikooUrl);a.setRequestHeader("Content-Type","application/json");a.send(e);clearInterval(commentInterval);commentInterval=null;commentInterval=setInterval((()=>{if(commentBarrageConfig.barrageList.length&&!hoverOnCommentBarrage){popCommentBarrage(commentBarrageConfig.barrageList[commentBarrageConfig.barrageIndex]);commentBarrageConfig.barrageIndex+=1;commentBarrageConfig.barrageIndex%=commentBarrageConfig.barrageList.length}if(commentBarrageConfig.barrageTimer.length>(commentBarrageConfig.barrageList.length>commentBarrageConfig.maxBarrage?commentBarrageConfig.maxBarrage:commentBarrageConfig.barrageList.length)&&!hoverOnCommentBarrage){removeCommentBarrage(commentBarrageConfig.barrageTimer.shift())}}),commentBarrageConfig.barrageTime)}function commentLinkFilter(e){e.sort(((e,a)=>e.created-a.created));let a=[];e.forEach((e=>{a.push(...getCommentReplies(e))}));return a}function getCommentReplies(e){if(e.replies){let a=[e];e.replies.forEach((e=>{a.push(...getCommentReplies(e))}));return a}else{return[]}}function popCommentBarrage(e){let a=document.createElement("div");a.className="comment-barrage-item";a.innerHTML=`\n          <div class="barrageHead">\n            <a class="barrageTitle ${e.mailMd5===commentBarrageConfig.mailMd5?"barrageBloggerTitle":""}" href="javascript:anzhiyu.scrollTo('#post-comment')"">\n              ${e.mailMd5===commentBarrageConfig.mailMd5?"博主":"热评"}\n            </a>\n            <div class="barrageNick">${e.nick}</div>\n            <img class="nolazyload barrageAvatar" src="https://cravatar.cn/avatar/${e.mailMd5}"/>\n            <a class="comment-barrage-close" href="javascript:anzhiyu.switchCommentBarrage()"><i class="anzhiyufont anzhiyu-icon-xmark"></i></a>\n          </div>\n          <anzhiyu class="barrageContent" onClick="window.location.hash = '${e.id}'">\n            ${e.comment}\n          </anzhiyu>\n        `;let r=a.querySelectorAll("anzhiyu pre");r.forEach((e=>{let a=document.createElement("span");a.innerText="【代码】";e.parentNode.replaceChild(a,e)}));let n=a.querySelectorAll("anzhiyu img");n.forEach((e=>{if(!e.classList.contains("tk-owo-emotion")){e.style.display="none";let a=document.createElement("span");a.innerText="【图片】";e.parentNode.replaceChild(a,e)}}));commentBarrageConfig.barrageTimer.push(a);commentBarrageConfig.dom.append(a)}function removeCommentBarrage(e){e.className="comment-barrage-item out";setTimeout((()=>{if(commentBarrageConfig.dom&&commentBarrageConfig.dom.contains(e)){commentBarrageConfig.dom.removeChild(e)}}),1e3)}const e=e=>{const a=document.querySelector(".comment-barrage");const r=document.getElementById("post-comment");e.forEach((e=>{if(r&&a&&document.body.clientWidth>768){a.style.bottom=e.isIntersecting?`-${commentBarrageConfig.maxBarrage*200}px`:"0"}}))};const a=new IntersectionObserver(e,{root:null,rootMargin:"0px",threshold:0});const r=document.getElementById("post-comment");if(r){a.observe(r)}initCommentBarrage();if(localStorage.getItem("commentBarrageSwitch")!=="false"){document.querySelector(".comment-barrage").style.display="flex";document.querySelector(".menu-commentBarrage-text").textContent="关闭热评"}else{document.querySelector(".comment-barrage").style.display="none";document.querySelector(".menu-commentBarrage-text").textContent="显示热评"}document.addEventListener("pjax:send",(function(){clearInterval(commentInterval)}))}