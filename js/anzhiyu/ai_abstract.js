(function(){const{randomNum:e,basicWordCount:t,btnLink:n,key:i,Referer:l,gptName:a,switchBtn:o,mode:r}=GLOBAL_CONFIG.postHeadAiDescription;const{title:s,postAI:c,pageFillDescription:d}=GLOBAL_CONFIG_SITE;let u=-1;let m=true;let y=r;let f=0;let h;let p=null;let g=false;let T=null;const b=document.querySelector(".post-ai-description");const E=b.querySelector(".ai-title .anzhiyufont.anzhiyu-icon-arrow-rotate-right");let L=b.querySelector(".anzhiyu-icon-circle-dot");const k=b.querySelector(".ai-explanation");let v="";let I="";let M=600;let A=0;let w=0;let S=[];let q=0;const G=j();const B=[D,J,U,_];const x=b.querySelectorAll(".ai-btn-item");const P=Array.from(x).filter((e=>e.id!=="go-tianli-blog"));P.forEach(((e,t)=>{e.addEventListener("click",(()=>{B[t]()}))}));document.getElementById("ai-tag").addEventListener("click",W);E.addEventListener("click",K);document.getElementById("go-tianli-blog").addEventListener("click",(()=>{window.open(n,"_blank")}));L.addEventListener("click",$);async function $(){if(!T){anzhiyu.snackbarShow("摘要还没加载完呢，请稍后。。。");return}L=b.querySelector(".anzhiyu-icon-circle-dot");L.style.opacity="0.2";if(p&&!g){p.pause();g=true;L.style.opacity="1";L.style.animation="";L.style.cssText="animation: ''; opacity: 1;cursor: pointer;";return}if(p&&g){p.play();g=false;L.style.cssText="animation: breathe .5s linear infinite; opacity: 0.2;cursor: pointer";return}const e={key:i,Referer:l};const t=new URLSearchParams({key:e.key,id:T});const n={method:"GET",headers:{"Content-Type":"application/json",Referer:e.Referer}};try{const e=await fetch(`https://summary.tianli0.top/audio?${t}`,n);if(e.status===403){console.error("403 refer与key不匹配。")}else if(e.status===500){console.error("500 系统内部错误")}else{const t=await e.blob();const n=URL.createObjectURL(t);p=new Audio(n);p.play();L.style.cssText="animation: breathe .5s linear infinite; opacity: 0.2;cursor: pointer";p.addEventListener("ended",(()=>{p=null;L.style.opacity="1";L.style.animation=""}))}}catch(e){console.error("请求发生错误❎")}}if(o){document.getElementById("ai-Toggle").addEventListener("click",Q)}O();V();function j(){return new IntersectionObserver((e=>{let t=e[0].isIntersecting;m=t;if(m){M=A===0?200:20;S[1]=setTimeout((()=>{if(w){A=0;w=0}if(A===0){k.innerHTML=v.charAt(0)}requestAnimationFrame(H)}),M)}}),{threshold:0})}function H(e){if(!m){return}if(!H.start)H.start=e;q=e-H.start;if(q>=20){H.start=e;if(A<I-1){let e=v.charAt(A+1);let t=/[,.，。!?！？]/.test(e)?150:20;if(k.firstElementChild){k.removeChild(k.firstElementChild)}k.innerHTML+=e;let n=document.createElement("div");n.className="ai-cursor";k.appendChild(n);A++;if(t===150){b.querySelector(".ai-explanation .ai-cursor").style.opacity="0.2"}if(A===I-1){G.disconnect();k.removeChild(k.firstElementChild)}S[0]=setTimeout((()=>{requestAnimationFrame(H)}),t)}}else{requestAnimationFrame(H)}}function C(){if(S.length){S.forEach((e=>{if(e){clearTimeout(e)}}))}}function R(e,t=true){A=0;w=1;C();m=false;q=0;G.disconnect();k.innerHTML=t?"生成中. . .":"请等待. . .";v=e;I=v.length;G.observe(b)}async function O(e=t){if(y==="tianli"){await F(e)}else{N()}}async function F(e){A=0;w=1;C();m=false;q=0;G.disconnect();e=Math.max(10,Math.min(2e3,e));const t={key:i,Referer:l};const n=(s+d).trim().substring(0,e);const a={key:t.key,content:n,url:location.href};const o={method:"POST",headers:{"Content-Type":"application/json",Referer:t.Referer},body:JSON.stringify(a)};console.info(n.length);try{let e=null;let t;if(e)clearInterval(e);e=setInterval((()=>{const e="生成中"+".".repeat(w);k.innerHTML=e;w=w%3+1}),500);const n=await fetch(`https://summary.tianli0.top/`,o);let i;if(n.status===403){i={summary:"403 refer与key不匹配。"}}else if(n.status===500){i={summary:"500 系统内部错误"}}else{i=await n.json()}t=i.summary.trim();T=i.id;setTimeout((()=>{E.style.opacity="1"}),300);if(t){R(t)}else{R("摘要获取失败!!!请检查Tianli服务是否正常!!!")}clearInterval(e)}catch(e){console.error(e);k.innerHTML="发生异常"+e}}function N(){const e=c.split(",").map((e=>e.trim()));if(e.length!==1){let t=Math.floor(Math.random()*e.length);while(t===u){t=Math.floor(Math.random()*e.length)}u=t;R(e[t])}else{R(e[0])}setTimeout((()=>{E.style.opacity="1"}),600)}function U(){A=0;w=1;C();m=false;q=0;k.innerHTML="生成中. . .";v="";I="";G.disconnect();S[2]=setTimeout((()=>{k.innerHTML=z()}),600)}function z(){let e=document.querySelectorAll(".relatedPosts-list a");if(!e.length){const t=document.querySelector(".card-widget.card-recent-post");if(!t)return"";e=t.querySelectorAll(".aside-list-item a");let n="";for(let t=0;t<e.length;t++){const i=e[t];n+=`<div class="ai-recommend-item"><span class="index">${t+1}：</span><a href="javascript:;" onclick="pjax.loadUrl('${i.href}')" title="${i.title}" data-pjax-state="">${i.title}</a></div>`}return`很抱歉，无法找到类似的文章，你也可以看看本站最新发布的文章：<br /><div class="ai-recommend">${n}</div>`}let t="";for(let n=0;n<e.length;n++){const i=e[n];t+=`<div class="ai-recommend-item"><span>推荐${n+1}：</span><a href="javascript:;" onclick="pjax.loadUrl('${i.href}')" title="${i.title}" data-pjax-state="">${i.title}</a></div>`}return`推荐文章：<br /><div class="ai-recommend">${t}</div>`}function _(){R("正在前往博客主页...",false);S[2]=setTimeout((()=>{if(window.pjax){pjax.loadUrl("/")}else{location.href=location.origin}}),1e3)}function D(){if(y=="tianli"){R("我是文章辅助AI: TianliGPT，点击下方的按钮，让我生成本文简介、推荐相关文章等。")}else{R(`我是文章辅助AI: ${a} GPT，点击下方的按钮，让我生成本文简介、推荐相关文章等。`)}}function J(){E.click()}function W(){if(y==="tianli"){b.querySelectorAll(".ai-btn-item").forEach((e=>e.style.display="none"));document.getElementById("go-tianli-blog").style.display="block";R("你好，我是Tianli开发的摘要生成助理TianliGPT，是一个基于GPT-4的生成式AI。我在这里只负责摘要的预生成和显示，你无法与我直接沟通，如果你也需要一个这样的AI摘要接口，可以在下方购买。")}else{b.querySelectorAll(".ai-btn-item").forEach((e=>e.style.display="block"));document.getElementById("go-tianli-blog").style.display="none";R(`你好，我是本站摘要生成助理${a} GPT，是一个基于GPT-4的生成式AI。我在这里只负责摘要的预生成和显示，你无法与我直接沟通。`)}}function K(){const n=(s+d).trim().substring(0,t);E.style.opacity="0.2";E.style.transitionDuration="0.3s";E.style.transform="rotate("+360*f+"deg)";if(n.length<=t){let t=n.length-Math.floor(Math.random()*e);while(t===h||n.length-t===h){t=n.length-Math.floor(Math.random()*e)}h=t;O(t)}else{let i=Math.floor(Math.random()*e)+t;while(i===h||n.length-i===h){i=Math.floor(Math.random()*e)+t}O(i)}f++}function Q(){y=y==="tianli"?"local":"tianli";if(y==="tianli"){document.getElementById("ai-tag").innerHTML="TianliGPT";L.style.opacity="1";L.style.cursor="pointer"}else{L.style.opacity="0";L.style.cursor="auto";if(document.getElementById("go-tianli-blog").style.display="block"){document.querySelectorAll(".ai-btn-item").forEach((e=>e.style.display="block"));document.getElementById("go-tianli-blog").style.display="none"}document.getElementById("ai-tag").innerHTML=a+" GPT"}O()}function V(){if(y==="tianli"){document.getElementById("ai-tag").innerHTML="TianliGPT"}else{document.getElementById("ai-tag").innerHTML=a+" GPT"}}})();